/*! pxlviewer 2014-09-16 */
window.PxlViewer=window.PxlViewer||function(a){return new PxlViewer.Base(a)},function(a){a.pxlCount=-1,a.created=new Array;var b=function(){};if(a.console=window.console||{log:b,debug:b,info:b,warn:b,error:b},"undefined"==typeof jQuery)throw new Error("PxlViewer requires jQuery.");if("undefined"==typeof OpenSeadragon)throw new Error("PxlViewer requires OpenSeadragon.");if("undefined"==typeof Mustache)throw new Error("PxlViewer requires Mustache.");if("undefined"==typeof YUI)throw new Error("PxlViewer requires YUI.");if("undefined"==typeof fabric)throw new Error("PxlViewer requires fabricjs.");a.Base=function(b){if(!("id"in b))throw new Error("The 'id' parameter needs to be specified");if(!("images"in b)||0==b.images.length)throw new Error("The 'images' parameter must be specified and must be non-empty.");this.options=b,this.images=b.images,a.pxlCount++,this.pxlIndex=a.pxlCount,a.created[a.pxlCount]=this,this.loadImage(0)},$.extend(a.Base.prototype,{loadImage:function(a){var b=this.images[a];if("undefined"==typeof b)throw new Error("Invalid index.");if(!1 in b)throw new Error("Image object must have an 'url' parameter.");this.currentImage=a;var c=document.createElement("script");c.type="text/javascript",c.src=b.url+"?GetInfoJson?callback=PxlViewer.onGetInfo("+this.pxlIndex+")",$("body").append(c)},onGetInfo:function(b){this.images[this.currentImage].info=b;var c=b.dirList.split("|"),d=this;this.viewer=new OpenSeadragon({id:this.options.id,tileSources:{height:parseInt(b.height),width:parseInt(b.width),tileSize:parseInt(b.tileWidth),minLevel:0,maxLevel:9,tileOverlap:0,getTileUrl:function(a,e,f){for(var g=Math.pow(2,9-a),h=1;h<c.length;h++)g==Math.floor(parseFloat(c[h]))&&(g=parseFloat(c[h]));var i=parseInt(b.tileWidth),j=parseInt(b.tileHeight),k=e*i,l=f*j;return d.images[d.currentImage].url+"?GetImage?x="+k+"&y="+l+"&width="+i+"&height="+j+"&zoom="+g+"&compression=70"}},prefixUrl:"static/",showNavigator:!0,animationTime:.5,blendTime:.1,constrainDuringPan:!0,maxZoomPixelRatio:2,visibilityRatio:1,showRotationControl:!0,timeout:12e4,autoHideControls:!1,showNavigationControl:!1,debugMode:!1,gestureSettingsMouse:{clickToZoom:!1,dblClickToZoom:!0,pinchRotate:!0,flickEnabled:!0,flickMinSpeed:70,flickMomentum:.3}}),this.viewer.addHandler("pan",function(){$("#magnificationDrawer.drawer").hasClass("active")&&$("#menuMagnification.drawerBtn").mouseup(),$("#viewMenuPanel.menu").hasClass("active")&&$("#menuView.menuBtn").mouseup()}),this.viewer.addHandler("full-screen",function(a){a.fullScreen?(this.menu.inject(),$("#viewerMenu > div:not(.special)").remove(),$("#menuFullScreen").addClass("isFullScreen")):$("#viewerMenu").remove()}),this.viewer.addHandler("resize",function(){d.annotations.resize()}),this.viewer.addHandler("open",function(){d.annotations=new a.Annotations(d),d.menu=new a.Menu(d.options.menu,d),d.menu.inject(),d.menu.update(b)})},destroy:function(){this.menu.destroy(),this.annotations.destroy(),$("#"+this.options.id).empty(),this.menu=null,a.created[this.pxlIndex]=null}}),a.onGetInfo=function(b){return function(c){return null===a.created[b]?void a.console.warn("Could not deliver image info to the correct viewer. It seems it was destroyed."):void a.created[b].onGetInfo(c)}}}(PxlViewer),function(a){a.Menu=function(a,b){this.options={showZoomControl:!0,showFullScreen:!0,showImageInfo:!1,showTools:!0,showBrowse:!1,showLayers:!1,showSplitScreen:!1,showRotationDrawer:!1,showAnnotationDrawer:!0,showRotationControl:!1},$.extend(this.options,a),this.base=b},$.extend(a.Menu.prototype,{inject:function(){if("undefined"==typeof this.html){if(this.html="<div id='viewerMenu'>",this.options.showFullScreen&&(this.html+=this._createButton("menuFullScreen","special")),this.options.showZoomControl){var a=this._createButton("menuMagnification","drawerBtn mag1","<span class='currentMag'>x1</span>"),b="";b+=this._createButton("mag1","setMag","<span>Overview</span>"),b+=this._createButton("mag2_5","setMag","<span>x2.5</span>"),b+=this._createButton("mag5","setMag","<span>x5</span>"),b+=this._createButton("mag10","setMag","<span>x10</span>"),b+=this._createButton("mag20","setMag","<span>x20</span>"),b+=this._createButton("mag40","setMag","<span>x40</span>"),b+=this._createButton("mag83","setMag","<span>x100</span>"),this.html+=this._createDrawer("magnificationDrawer",a,b)}if(this.options.showImageInfo){var a=this._createButton("menuView","menuBtn"),b="";b+=this._createViewRow("imageInfoIcon","Image Information"),b+=this._createViewRow("labelIcon","Label"),this.html+=this._createMenu("viewMenuPanel",a,b)}if(this.options.showTools&&(this.html+=this._createButton("menuTools","button")),this.options.showBrowse&&(this.html+=this._createButton("menuBrowse","button")),this.options.showLayers){var a=this._createButton("menuLayers","panelBtn");this.html+=this._createPanel("layersPanel",a,"")}if(this.options.showSplitScreen&&(this.html+=this._createButton("menuSplitScreen","button")),this.options.showRotationDrawer){var a=this._createButton("menuRotate","drawerBtn"),b="";b+=this._createButton("rotate0","rotateBtn"),b+=this._createButton("rotate90","rotateBtn"),b+=this._createButton("rotate180","rotateBtn"),b+=this._createButton("rotate270","rotateBtn"),this.html+=this._createDrawer("rotateDrawer",a,b)}if(this.options.showAnnotationDrawer){var a=this._createButton("menuAnnotation","drawerBtn annotationBtn","<span>anno</span>"),b="";b+=this._createButton("annoSq","button","<span>sq</span>"),b+=this._createButton("annoCirc","button","<span>circ</span>"),b+=this._createButton("annoFree","button","<span>free</span>"),b+=this._createButton("annoArr","button","<span>arr</span>"),b+=this._createButton("annoSave","button","<span>save</span>"),b+=this._createButton("annoLoad","button","<span>load</span>"),this.html+=this._createDrawer("annotationDrawer",a,b)}this.options.showCustomButtons&&(this.html+=this._createButton("","space"),this.html+=this._createButton("menuCustom1","button"),this.html+=this._createButton("menuCustom2","button"),this.html+=this._createButton("menuCustom3","button")),this.html+=this._createButton("panelExpand","button","<span>-></span>"),this.html+=this._createButton("panelShrink","button","<span><-</span>"),this.html+="</div>"}$("#leftMenuHolder").append(this.html);var c=this;this.options.showRotationControl&&YUI().use("dial",function(a){var b=new a.Dial({min:-180,max:180,stepsPerRevolution:180,value:0,strings:{label:"Rotation",resetStr:"Reset",tooltipHandle:"Drag to rotate"},after:{valueChange:function(a){c.base.viewer.viewport.setRotation(a.newVal)}}}),d=document.createElement("div");d.id="rotateDial_"+(new Date).getTime(),d.className="rotateDial",$("body").append(d),b.render("#"+d.id)}),this._hookupEvents()},update:function(a){a.mag<83&&$("#mag83").remove(),a.mag<40&&$("#mag40").remove(),a.mag<20&&$("#mag20").remove(),a.mag<10&&$("#mag10").remove(),a.mag<5&&$("#mag5").remove(),a.mag<2.5&&$("#mag2_5").remove(),a.mag<1,$("#mag1 span").text("x"+parseFloat(this.base.viewer.viewport.viewportToImageZoom(this.base.viewer.viewport.getHomeZoom()*a.mag))),a.stacks<=1;var b=$("#view1")[0];b.msRequestFullscreen||b.requestFullscreen||b.mozRequestFullScreen||b.webkitRequestFullscreen||$("#menuFullScreen").remove();var c=this;this.base.viewer.addHandler("update-viewport",function(b){var d=b.eventSource.viewport.getZoom(!0);null!=d&&(d*=a.mag,d=b.eventSource.viewport.viewportToImageZoom(d),d=parseFloat(d).toFixed(1),d=parseFloat(d),c._updateMenuMagnification(d))})},_createButton:function(a,b,c){return Mustache.render("<div class='{{cssClass}}' id='{{id}}'>{{{contents}}}</div>",{id:a,cssClass:b,contents:c})},_createDrawer:function(a,b,c){var d="                <div class='drawerContainer'>                     {{{btn}}}                     <div style='display: none;' class='drawer' id='{{id}}'>                       {{{contents}}}                     </div>                 </div>";return Mustache.render(d,{id:a,btn:b,contents:c})},_createMenu:function(a,b,c){var d="                <div class='menuContainer'>                     {{{btn}}}                     <div style='display: none;' class='menu' id='{{id}}'>                       {{{contents}}}                     </div>                 </div>";return Mustache.render(d,{id:a,btn:b,contents:c})},_createViewRow:function(a,b){var c="                <div class='viewRow'>                     <div class='viewIcon' id='{{id}}'>                     </div>                     <div class='favIcon'></div>                     <input type='checkbox' class='viewCheckbox' id='{{id}}_chkBox'>                     <label class='checkboxLabel checkboxImage' for='{{id}}_chkBox' id='{{id}}_lbl'>{{text}}</label>                 </div>";return Mustache.render(c,{id:a,text:b})},_createPanel:function(a,b,c){var d="                <div class='panelContainer'>                     {{{btn}}}                     <div style='display: none;' class='panel' id='{{id}}'>                       {{{contents}}}                     </div>                 </div>";return Mustache.render(d,{id:a,btn:b,contents:c})},_slideOut:function(a,b,c,d){if($(a).parent().children(b).hasClass("active")){$(a).animate({left:"+="+(c+40)+"px"},500);var e={left:"+="+c+"px",opacity:"0"};d&&(e.left=void 0,e.right="+="+c+"px"),$(a).parent().children(b).animate(e,{duration:500,complete:function(){$(a).parent().children(b).hide()}}),$(a).parent().children(b).removeClass("active"),$(a).removeClass("active")}else{var e={left:"+="+c+"px"};d&&(e.left=void 0,e.right="0px"),$(a).parent().children(b).show(),$(a).css("position","absolute"),$(a).css("left","40px"),$(a).animate({left:"+="+c+"px"},500),$(a).parent().children(b).css("opacity","1"),$(a).parent().children(b).animate(e,500),$(a).parent().children(b).addClass("active"),$(a).addClass("active")}},_calculateDrawerWidth:function(a){var b=$(a).parent().children(".drawer").is(":visible");$(a).parent().children(".drawer").show();var c=$(a).parent().find(".drawer > div:first"),d=c[0].clientWidth+parseFloat(c.css("marginLeft"))+parseFloat(c.css("marginRight")),e=$(a).parent().children(".drawer").children("div").length,f=d*e-21;return b||$(a).parent().children(".drawer").hide(),f},_calculateMenuWidth:function(a){if(0==a.length)return 0;$(a).parent().children(".menu").show();var b=$(a).parent().children(".menu")[0].clientWidth;return $(a).parent().children(".menu").css("left","0"),$(a).parent().children(".menu").css("width","900px"),$(a).parent().children(".menu").hide(),b},_calculatePanelWidth:function(a){if(0==a.length)return 0;$(a).parent().children(".panel").show();var b=$(a).parent().children(".panel")[0].clientWidth;return $(a).parent().children(".panel").css("right","-310px"),$(a).parent().children(".panel").hide(),b-40},_expandPanel:function(){$("#viewerHolder").css("margin-left","300px"),$("#viewerHolder").width("calc(100% - 300px)"),$("#leftMenuHolder").animate({width:"300px"},500,function(){})},_shrinkPanel:function(){$("#viewerHolder").css("margin-left","40px"),$("#viewerHolder").width("calc(100% - 40px)"),$("#leftMenuHolder").animate({width:"40px"},500,function(){})},_hookupEvents:function(){var b=this;$("#menuFullScreen").mouseup(function(){b.base.viewer.setFullScreen(!this.base.isFullScreen),b.base.isFullScreen=!this.base.isFullScreen}),$(".drawerBtn").mouseup(function(){b._slideOut(this,".drawer",b._calculateDrawerWidth(this))});var c=b._calculateMenuWidth($(".menuBtn"));$(".menuBtn").mouseup(function(){b._slideOut(this,".menu",c)});var d=b._calculatePanelWidth($(".panelBtn"));$(".panelBtn").mouseup(function(){b._slideOut(this,".panel",d,!0)}),$(".setMag").mouseup(function(){var a=b.base.viewer.viewport.getCenter(!1),c=b.base.images[b.base.currentImage].info.mag,d="";switch($(this).get(0).id){case"mag1":b.base.viewer.viewport.zoomTo(b.base.viewer.viewport.getHomeZoom(),a,!1);break;case"mag2_5":b.base.viewer.viewport.zoomTo(b.base.viewer.viewport.imageToViewportZoom(2.5/c),a,!1);break;case"mag5":b.base.viewer.viewport.zoomTo(b.base.viewer.viewport.imageToViewportZoom(5/c),a,!1);break;case"mag10":b.base.viewer.viewport.zoomTo(b.base.viewer.viewport.imageToViewportZoom(10/c),a,!1);break;case"mag20":b.base.viewer.viewport.zoomTo(b.base.viewer.viewport.imageToViewportZoom(20/c),a,!1),d="x20";break;case"mag40":b.base.viewer.viewport.zoomTo(b.base.viewer.viewport.imageToViewportZoom(40/c),a,!1);break;case"mag83":b.base.viewer.viewport.zoomTo(b.base.viewer.viewport.imageToViewportZoom(100/c),a,!1)}$(this).parent().parent().children(".drawerBtn").attr("class","drawerBtn "+$(this).get(0).id)}),$(".rotateBtn").mouseup(function(){b.base.viewer.viewport.getCenter(!1);switch($(this).get(0).id){case"rotate0":b.base.viewer.viewport.setRotation(0);break;case"rotate90":b.base.viewer.viewport.setRotation(90);break;case"rotate180":b.base.viewer.viewport.setRotation(45);break;case"rotate270":b.base.viewer.viewport.setRotation(270)}$(this).parent().parent().children(".drawerBtn").attr("class","drawerBtn "+$(this).get(0).id)}),$("#menuTools").mouseup(function(){b.base.annotations.toggleDrawingMode()}),$("#annoFree").mouseup(function(){b.base.annotations.toggleDrawingMode()}),$("#annoCirc").mouseup(function(){b.base.annotations.enterEditMode();var a=b.base.viewer.viewport.getCenter(!0);a=b.base.viewer.viewport.viewportToImageCoordinates(a),b.base.annotations.addEllipse(new OpenSeadragon.Rect(a.x,a.y,200,200),"red")}),$("#annoSq").mouseup(function(){b.base.annotations.enterEditMode();var a=b.base.viewer.viewport.getCenter(!0);a=b.base.viewer.viewport.viewportToImageCoordinates(a),b.base.annotations.addRectangle(new OpenSeadragon.Rect(a.x,a.y,400,400),"red",b.base.viewer.viewport.viewportToImageZoom(b.base.viewer.viewport.getZoom()*b.base.images[b.base.currentImage].info.mag),!0)}),$("#annoSave").mouseup(function(){if(a.console.log("annoSave mouseup"),b.base.annotations.isEditMode){a.console.log("annoSave isEditMode count "+b.base.annotations.objects.length+" , "+b.base.annotations.objects[0].isActive);for(var c=0;c<b.base.annotations.objects.length;c++)if(b.base.annotations.objects[c].isActive){a.console.log(b.base.annotations.objects[c]),a.console.log(b.base.annotations.objects[c].obj.left+","+b.base.annotations.objects[c].obj.top);var d=b.base.viewer.viewport.windowToImageCoordinates(new OpenSeadragon.Point(b.base.annotations.objects[c].obj.left,b.base.annotations.objects[c].obj.top));a.console.log(d)}b.base.annotations.exitEditMode()}else a.console.log("Annotation not saved as it is not in edit mode")}),$("#annoLoad").mouseup(function(){b.base.annotations.loadAnnotationsPanel()}),$("#panelExpand").mouseup(function(){b._expandPanel()}),$("#panelShrink").mouseup(function(){b._shrinkPanel()})},_updateMenuMagnification:function(a){$(".drawerBtn .currentMag").text("x"+a),2.5>a?$("#menuMagnification").attr("class","drawerBtn mag1"):5>a?$("#menuMagnification").attr("class","drawerBtn mag2_5"):10>a?$("#menuMagnification").attr("class","drawerBtn mag5"):20>a?$("#menuMagnification").attr("class","drawerBtn mag10"):40>a?$("#menuMagnification").attr("class","drawerBtn mag20"):a>=40&&83>a?$("#menuMagnification").attr("class","drawerBtn mag40"):$("#menuMagnification").attr("class","drawerBtn mag83")},destroy:function(){$("#viewerMenu").remove(),$(".rotateDial").remove()}})}(PxlViewer),function(a){a.Annotations=function(a){this._init(a,!1)},$.extend(a.Annotations.prototype,{_init:function(b,c){a.console.log("_init");var d=this;this.base=b;var e=b.viewer.viewport.getBounds(),f=document.createElement("canvas"),g=new Date,h=g.getSeconds();f.id="annotationCanvas"+h,f.style.position="absolute",f.style.top="0px",f.style.left="0px",c?(a.console.log($(c)),$(c).append(f),this.canvas=new fabric.Canvas(f),this.canvas.freeDrawingBrush.width=3,this.canvas.selection=!0):($(b.viewer.canvas).append(f),this.canvas=new fabric.StaticCanvas(f),this.canvas.selection=!1,b.viewer.addOverlay(f,new OpenSeadragon.Rect(0,0,e.width,e.height),OpenSeadragon.OverlayPlacement.CENTER,function(){d.update()})),this.canvas.setWidth(b.viewer.element.clientWidth),this.canvas.setHeight(b.viewer.element.clientHeight),this.objects=new Array,this.origImgSize=this._getWindowImageSize(),this.group=new fabric.Group([]),this.group.selectable=!1,this.group.width=b.viewer.element.clientWidth/this.base.viewer.viewport.getZoom(!0),this.group.height=b.viewer.element.clientHeight/this.base.viewer.viewport.getZoom(!0),this.group.centeredRotation=!0,this.group.origScaleX=this.group.scaleX,this.group.origScaleY=this.group.scaleY,this.group.originX="center",this.group.originY="center",this.group.perPixelTargetFind=!0,this.canvas.add(this.group),this.canvas.on("path:created",function(a){var b=(d.canvas.getCenter(),d.base.viewer.viewport.getRotation()),c=d.group.getPointByOrigin("left","top"),e=new fabric.Point(a.path.left,a.path.top),f=fabric.util.rotatePoint(e,c,-b*(Math.PI/180)),g=d.base.viewer.viewport.windowToImageCoordinates(new OpenSeadragon.Point(f.x,f.y)),h=new OpenSeadragon.Rect(g.x,g.y,a.path.width,a.path.height),i={type:"path",origDimensions:h,obj:a.path},j=d._windowToGroupCoordinates(new fabric.Point(f.x,f.y));i.obj.left=j.x,i.obj.top=j.y;var k=d.base.viewer.viewport.getZoom(!0);i.origZoom=k,i.origStrokeWidth=i.obj.strokeWidth,i.obj.angle=-b,i.obj.scaleX=1/k,i.obj.scaleY=1/k,d.group.add(i.obj),d.objects.push(i)})},update:function(){var a=this.canvas.getCenter(),b=this.base.viewer.viewport.imageToWindowCoordinates(new OpenSeadragon.Point(this.base.images[this.base.currentImage].info.width/2,this.base.images[this.base.currentImage].info.height/2));this.group.left=b.x,this.group.top=b.y;var c=this.base.viewer.viewport.getRotation(),d=new fabric.Point(a.left,a.top),e=new fabric.Point(this.group.left,this.group.top),f=fabric.util.rotatePoint(e,d,c*(Math.PI/180));this.group.left=f.x,this.group.top=f.y,this.group.angle=c;var g=this.base.viewer.viewport.getZoom(!0);this.group.scaleX=this.group.origScaleX,this.group.scaleY=this.group.origScaleY,this.group.scaleX*=g,this.group.scaleY*=g;for(var h=0;h<this.objects.length;h++){var i=this.objects[h],g=this.base.viewer.viewport.getZoom(!0);i.obj.strokeWidth=i.origStrokeWidth,i.obj.strokeWidth*=i.origZoom/g,i.obj.strokeWidth>8&&(i.obj.strokeWidth=8)}this.canvas.renderAll()},loadAnnotationsPanel:function(a){var b;$("#"+a).length>0?b=$("#"+a):(b=$(document.createElement("div")),b.attr("id","annoPanel"),b.attr("className","annoPanel"),a="annoPanel"),$("#leftPanel").append(b),this.retrieveAnnotations(a)},retrieveAnnotations:function(b){if(a.console.log(this.base.images[this.base.currentImage].id),this.base.images[this.base.currentImage].id>0){var c=this;ViewerWebService.GetAnnotations($("#hiddenGuid").val(),this.base.images[this.base.currentImage].id,function(d){var e=jQuery.parseJSON(d);c.base.annotations.completeAnnotationList=new Array,$("#"+b).empty();for(var f=0;f<e.length;f++)c.base.annotations.completeAnnotationList.push(e[f][0]),$("#"+b).append(c.base.annotations._createAnnotationDataContol(e[f][0].ID,e[f][0].Name)),a.console.log(c.base.annotations.completeAnnotationList),$("#an"+e[f][0].ID).mouseup(function(){var b=c.base.annotations._getAnnotationObjectFromArray(c.base.annotations.completeAnnotationList,"ID",$(this).attr("annoID"));a.console.log(b),c.base.annotations._loadAnnotation(b)})},function(){a.console.log("Could not retrieve annotations ")})}},_createAnnotationDataContol:function(a,b){var c="                <div class='anDataControl' id='an{{id}}' annoID='{{id}}' >                     {{{name}}}                 </div>";return Mustache.render(c,{id:a,name:b})},_getAnnotationObjectFromArray:function(a,b,c){for(var d=0;d<a.length;d++)if(a[d][b]==c)return a[d];return null},resize:function(){a.console.log("resize anno");var b=this.origImgSize,c=this._getWindowImageSize(),d=c.x/b.x,e=c.y/b.y,f=this.base,g=this.objects;this.destroy(),this._init(f,!1),this.update(),this.canvas.renderOnAddRemove=!1;for(var h=0;h<g.length;h++){{var i=this._imageToGroupCoordinates(new fabric.Point(g[h].origDimensions.x,g[h].origDimensions.y));this._rotatePoint(new fabric.Point(i.x,i.y))}g[h].obj.left=i.x,g[h].obj.top=i.y,g[h].obj.scaleX=d,g[h].obj.scaleY=e,this.group.add(g[h].obj),this.objects.push(g[h])}this.canvas.renderOnAddRemove=!0,this.update(),this.origImgSize=b},_rotatePoint:function(a){var b=this.canvas.getCenter(),c=this.base.viewer.viewport.getRotation(),d=new fabric.Point(b.left,b.top),e=fabric.util.rotatePoint(a,d,c*(Math.PI/180));return e},_imageToGroupCoordinates:function(a){var b=this.base.viewer.viewport.imageToWindowCoordinates(a);return this._windowToGroupCoordinates(b)},_windowToGroupCoordinates:function(a){var b=this.group.getPointByOrigin("left","top"),c=this.base.viewer.viewport.getZoom(!0);return new OpenSeadragon.Point((a.x-b.x)/c-this.group.width/2,(a.y-b.y)/c-this.group.height/2)},enterEditMode:function(){var a=this.base;this.isEditMode=!0;var b=this.objects;this.destroy(),this._init(a,"#annoCanvas1"),this.base.viewer.setMouseNavEnabled(!1),this.canvas.renderOnAddRemove=!1;for(var c=0;c<b.length;c++)this.group.add(b[c].obj),this.objects.push(b[c]);this.canvas.renderOnAddRemove=!0,this.update()},exitEditMode:function(){var a=this.base;this.isEditMode=!1,this.base.viewer.setMouseNavEnabled(!0);var b=this.objects;this.destroy(),this._init(a,!1),this.canvas.isDrawingMode=!1,this.canvas.renderOnAddRemove=!1;for(var c=0;c<b.length;c++)this.group.add(b[c].obj),this.objects.push(b[c]);this.canvas.renderOnAddRemove=!0,this.update()},_loadAnnotation:function(b){this.destroy();var c=this.base;this._init(c,!1),this.canvas.isDrawingMode=!1,this.base.viewer.setMouseNavEnabled(!0),a.console.log("loading annotation;"),this.base.annotations.addRectangle(new OpenSeadragon.Rect(b.X,b.Y,b.Width,b.Height),b.Color,b.Zoom,!1)},_getWindowImageSize:function(){var a=this.base.viewer.viewport,b=this.base.images[this.base.currentImage].info,c=a.imageToWindowCoordinates(new OpenSeadragon.Point(0,0)),d=a.imageToWindowCoordinates(new OpenSeadragon.Point(b.width-1,b.height-1));return new OpenSeadragon.Point(d.x-c.x,d.y-c.y)},addRectangle:function(b,c,d,e){var f={type:"rect",origDimensions:b,obj:new fabric.Rect({left:b.x,top:-9999,width:b.width,height:b.height,fill:"rgba(0,0,0,0)",borderColor:c,cornerColor:c,cornerSize:34,stroke:c,strokeWidth:3,selectable:e,originX:"center",originY:"center",strokeLineJoin:"round",transparentCorners:!1})};if(a.console.log("allowedit "+e),f.isActive=!0,f.origStrokeWidth=f.obj.strokeWidth,f.origZoom=d,a.console.log("AnnoZoom = "+this.base.viewer.viewport.getZoom()),a.console.log("AnnoZoom = "+this.base.viewer.viewport.getZoom()*this.base.images[this.base.currentImage].info.mag),a.console.log("ImageZoom = "+this.base.viewer.viewport.viewportToImageZoom(this.base.viewer.viewport.getZoom()*this.base.images[this.base.currentImage].info.mag)),e){var g=this.base.viewer.viewport.imageToWindowCoordinates(new OpenSeadragon.Point(f.origDimensions.x,f.origDimensions.y));f.obj.left=g.x,f.obj.top=g.y,this.canvas.add(f.obj)}else{var h=this._imageToGroupCoordinates(new OpenSeadragon.Point(f.origDimensions.x,f.origDimensions.y));f.obj.left=h.x+f.obj.rx,f.obj.top=h.y+f.obj.ry,this.group.add(f.obj)}var i=this.base.viewer.viewport.imageToViewportCoordinates(new OpenSeadragon.Point(1e4,1e4));this.base.viewer.viewport.getZoom()==this.base.viewer.viewport.imageToViewportZoom(1)?this.base.viewer.viewport.panTo(i,!1):this.base.viewer.viewport.zoomTo(this.base.viewer.viewport.imageToViewportZoom(1),i,!1),this.objects.push(f),this.update()},addEllipse:function(a,b){var c={type:"ellipse",origDimensions:a,obj:new fabric.Ellipse({left:-9999,top:-9999,rx:a.width,ry:a.height,selectable:!0,fill:"rgba(0,0,0,0)",stroke:b,strokeWidth:3,originX:"center",originY:"center",borderColor:b,cornerColor:b,cornerSize:34})};c.isActive=!0,c.origStrokeWidth=c.obj.strokeWidth,c.origZoom=this.base.viewer.viewport.getZoom(!0);var d=this.base.viewer.viewport.imageToWindowCoordinates(new OpenSeadragon.Point(c.origDimensions.x,c.origDimensions.y));c.obj.left=d.x,c.obj.top=d.y,this.canvas.add(c.obj);var e=this._imageToGroupCoordinates(new OpenSeadragon.Point(c.origDimensions.x,c.origDimensions.y));c.obj.groupLeft=e.x+c.obj.rx,c.obj.groupTop=e.y+c.obj.ry,this.objects.push(c),this.update()},toggleDrawingMode:function(){var a=this.base,b=this.objects;this.canvas.isDrawingMode?(this.destroy(),this._init(a,!1),this.canvas.isDrawingMode=!1,this.base.viewer.setMouseNavEnabled(!0)):(this.destroy(),this._init(a,"body"),this.canvas.isDrawingMode=!0,this.base.viewer.setMouseNavEnabled(!1)),this.canvas.renderOnAddRemove=!1;for(var c=0;c<b.length;c++)this.group.add(b[c].obj),this.objects.push(b[c]);this.canvas.renderOnAddRemove=!0,this.update()},destroy:function(){a.console.log(this.canvas.getElement().id),this.canvas.clear(),$(this.canvas.getElement()).remove(),$(this.canvas.wrapperEl).remove(),this.canvas.dispose(),this.objects=null,this.group=null,this.canvas=null}})}(PxlViewer);